/*
 * jQuery Last.fm Profile Plugin v0.9
 * http://terkel.jp/archives/2011/07/jquery-lastfm-profile-plugin/
 * 
 * Copyright (c) 2011 Takeru Suzuki
 * Dual licensed under the MIT and GPL licenses.
 * 
 * Requires: jQuery 1.4.3+
 */
(function(h){h.fn.loadLastfmProfile=function(e){e=h.extend({},h.fn.loadLastfmProfile.defaults,e);return this.each(function(){var d=h(this),m={user:d.data("lastfm-user"),method:d.data("lastfm-method"),period:d.data("lastfm-period"),limit:d.data("lastfm-limit"),image:d.data("lastfm-image"),imageSize:d.data("lastfm-image-size"),imageSquare:d.data("lastfm-image-square"),text:d.data("lastfm-text"),playcount:d.data("lastfm-playcount"),loadingMessage:d.data("lastfm-loading-message"),contentBefore:d.data("lastfm-content-before"),contentAfter:d.data("lastfm-content-after")},a=h.extend({},e,m);d[0].innerHTML='<p class="loading">'+a.loadingMessage+"</p>";h.getJSON("http://ws.audioscrobbler.com/2.0/?callback=?",{api_key:"c1e773908a041598767406c5d32c022e",format:"json",user:a.user,method:function(){return a.method==="NowPlaying"?"user.getRecentTracks":"user.get"+a.method},period:a.period,limit:a.limit},function(c){var c=a.method==="TopAlbums"?c.topalbums.album:a.method==="TopArtists"?c.topartists.artist:a.method==="TopTracks"?c.toptracks.track:a.method==="RecentTracks"?c.recenttracks.track:a.method==="NowPlaying"?c.recenttracks.track:"",f=[],g=-1,e=!1;h.isArray(c)||(c=[c]);if(c[0]["@attr"]&&c[0]["@attr"].nowplaying==="true")a.method==="RecentTracks"?c.shift():a.method==="NowPlaying"&&(c=[c[0]],e=!0);else if(a.method==="NowPlaying")return d.empty(),this;f[++g]=a.contentBefore;f[++g]=e?"<ul>":"<ol>";h.each(c,function(d,b){var c,e,i,j,l,k;a.image&&(b.image&&h.each(b.image,function(b,c){c.size===a.imageSize&&(e=c["#text"],a.imageSquare&&(e=e.replace(/(http:\/\/userserve-ak.last.fm\/serve\/(34|64|126))\//,"$1s/")))}),e||(e="http://cdn.last.fm/flatness/catalogue/noimage/2/default_artist_"+a.imageSize+".png"),i=a.text?"":!b.artist?b.name.escapeHTML():b.artist.name?b.name.escapeHTML()+" &#8211; "+b.artist.name.escapeHTML():b.artist["#text"]?b.name.escapeHTML()+" &#8211; "+b.artist["#text"].escapeHTML():"");a.text?b.artist&&(j=b.artist.name?b.artist.name:b.artist["#text"],l=b.artist.url?b.artist.url:"http://www.last.fm/music/"+j.replace(/\s/g,"+")):c=i;a.playcount&&b.playcount&&(k=b.url.replace(/^(http:\/\/www\.last\.fm\/)/,"$1user/"+a.user+"/library/"));f[++g]="<li>";f[++g]='<a href="'+b.url+'"';f[++g]=c?' title="'+c+'"':"";f[++g]=' class="item">';f[++g]=a.image?'<img src="'+e+'" alt="'+i+'" class="photo">':"";f[++g]=a.text?'<span class="name">'+b.name+"</span>":"";f[++g]="</a>";f[++g]=a.text&&b.artist?' &#8211; <a href="'+l+'" class="artist">'+j+"</a>":"";f[++g]=k?' <span class="playcount">(<a href="'+k+'">'+b.playcount+" plays</a>)</span>":"";f[++g]="</li>"});f[++g]=e?"</ul>":"</ol>";f[++g]=a.contentAfter;d[0].innerHTML=f.join("")})})};h.fn.loadLastfmProfile.defaults={user:"LAST.HQ",method:"TopAlbums",period:"7day",limit:10,image:!0,imageSize:"medium",imageSquare:!0,text:!0,playcount:!0,loadingMessage:"Loading&#8230;",contentBefore:"",contentAfter:""}})(jQuery);String.prototype.escapeHTML=function(){var h=/["&<>]/g,e={'"':"&quot;","&":"&amp;","<":"&lt;",">":"&gt;"};return function(){return this.replace(h,function(d){return e[d]})}}();