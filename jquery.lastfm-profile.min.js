/*
 * jQuery Last.fm Profile Plugin v0.9.2
 * http://terkel.jp/archives/2011/07/jquery-lastfm-profile-plugin/
 * 
 * Copyright (c) 2012 Takeru Suzuki - http://terkel.jp/
 * Licensed under the MIT license - http://www.opensource.org/licenses/MIT
 */
(function(f){f.fn.loadLastfmProfile=function(g){return this.each(function(){var d=f(this),l={user:d.data("lastfm-user"),method:d.data("lastfm-method"),period:d.data("lastfm-period"),limit:d.data("lastfm-limit"),image:d.data("lastfm-image"),imageSize:d.data("lastfm-image-size"),imageSquare:d.data("lastfm-image-square"),text:d.data("lastfm-text"),playcount:d.data("lastfm-playcount"),loadingMessage:d.data("lastfm-loading-message"),errorMessage:d.data("lastfm-error-message"),contentBefore:d.data("lastfm-content-before"),contentAfter:d.data("lastfm-content-after")},c=f.extend({},f.fn.loadLastfmProfile.defaults,g,l);d[0].innerHTML='<p class="loading">'+c.loadingMessage+"</p>";f.ajax({type:"GET",dataType:"json",url:"http://ws.audioscrobbler.com/2.0/?callback=?",data:{api_key:"c1e773908a041598767406c5d32c022e",format:"json",user:c.user,method:function(){return c.method==="NowPlaying"?"user.getRecentTracks":"user.get"+c.method},period:c.period,limit:c.limit},success:function(h){var e=function(){switch(c.method){case "TopAlbums":return h.topalbums.album;case "TopArtists":return h.topartists.artist;case "TopTracks":return h.toptracks.track;case "RecentTracks":case "NowPlaying":return h.recenttracks.track;default:return""}}(),a=[],g=false;f.isArray(e)||(e=[e]);if(e[0]["@attr"]&&e[0]["@attr"].nowplaying==="true")c.method==="RecentTracks"?e.shift():c.method==="NowPlaying"&&(e=[e[0]],g=true);else if(c.method==="NowPlaying")return d.empty(),this;a[a.length]=c.contentBefore;a[a.length]=g?"<ul>":"<ol>";f.each(e,function(d,b){var e,g="http://cdn.last.fm/flatness/catalogue/noimage/2/default_artist_"+c.imageSize+".png",h,i,k,j;c.image&&(b.image&&f.each(b.image,function(a,b){b.size===c.imageSize&&(g=c.imageSquare?b["#text"].replace(/(http:\/\/userserve-ak.last.fm\/serve\/(34|64|126))\//,"$1s/"):b["#text"])}),h=c.text?"":!b.artist?b.name.escapeHTML():b.artist.name?b.name.escapeHTML()+" &#8211; "+b.artist.name.escapeHTML():b.artist["#text"]?b.name.escapeHTML()+" &#8211; "+b.artist["#text"].escapeHTML():"");c.text?b.artist&&(i=b.artist.name?b.artist.name:b.artist["#text"],k=b.artist.url?b.artist.url:"http://www.last.fm/music/"+i.replace(/\s/g,"+")):e=h;c.playcount&&b.playcount&&(j=b.url.replace(/^(http:\/\/www\.last\.fm\/)/,"$1user/"+c.user+"/library/"));a[a.length]="<li>";a[a.length]='<a href="'+b.url+'"';a[a.length]=e?' title="'+e+'"':"";a[a.length]=' class="item" target="_blank">';a[a.length]=c.image?'<img src="'+g+'" alt="'+h+'" class="photo">':"";a[a.length]=c.text?'<span class="name">'+b.name+"</span>":"";a[a.length]="</a>";a[a.length]=c.text&&b.artist?' &#8211; <a href="'+k+'" class="artist" target="_blank">'+i+"</a>":"";a[a.length]=j?' <span class="playcount">(<a href="'+j+'" target="_blank">'+b.playcount+" plays</a>)</span>":"";a[a.length]="</li>"});a[a.length]=g?"</ul>":"</ol>";a[a.length]=c.contentAfter;d[0].innerHTML=a.join("")},error:function(){d[0].innerHTML='<p class="error">'+c.errorMessage+"</p>"}})})};f.fn.loadLastfmProfile.defaults={user:"LAST.HQ",method:"TopAlbums",period:"7day",limit:10,image:true,imageSize:"medium",imageSquare:true,text:true,playcount:true,loadingMessage:"Loading&#8230;",errorMessage:"Failed to load data.",contentBefore:"",contentAfter:""}})(jQuery);String.prototype.escapeHTML=function(){var f=/["&<>]/g,g={'"':"&quot;","&":"&amp;","<":"&lt;",">":"&gt;"};return function(){return this.replace(f,function(d){return g[d]})}}();