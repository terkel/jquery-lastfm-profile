/*
 * jQuery Last.fm Profile Plugin v0.9
 * http://terkel.jp/archives/2011/07/jquery-lastfm-profile-plugin/
 * 
 * Copyright (c) 2011 Takeru Suzuki
 * Dual licensed under the MIT and GPL licenses.
 * 
 * Requires: jQuery 1.4.3+
 */
(function(h){h.fn.loadLastfmProfile=function(f){f=h.extend({},h.fn.loadLastfmProfile.defaults,f);return this.each(function(){var c=h(this),m={user:c.data("lastfm-user"),method:c.data("lastfm-method"),period:c.data("lastfm-period"),limit:c.data("lastfm-limit"),image:c.data("lastfm-image"),imageSize:c.data("lastfm-image-size"),imageSquare:c.data("lastfm-image-square"),text:c.data("lastfm-text"),playcount:c.data("lastfm-playcount"),loadingMessage:c.data("lastfm-loading-message"),contentBefore:c.data("lastfm-content-before"),contentAfter:c.data("lastfm-content-after")},a=h.extend({},f,m);c[0].innerHTML='<p class="loading">'+a.loadingMessage+"</p>";h.getJSON("http://ws.audioscrobbler.com/2.0/?callback=?",{api_key:"c1e773908a041598767406c5d32c022e",format:"json",user:a.user,method:function(){return a.method==="NowPlaying"?"user.getRecentTracks":"user.get"+a.method},period:a.period,limit:a.limit},function(f){var d=function(){switch(a.method){case "TopAlbums":return f.topalbums.album;case "TopArtists":return f.topartists.artist;case "TopTracks":return f.toptracks.track;case "RecentTracks":case "NowPlaying":return f.recenttracks.track;default:return""}}(),e=[],g=-1,i=!1;h.isArray(d)||(d=[d]);if(d[0]["@attr"]&&d[0]["@attr"].nowplaying==="true")a.method==="RecentTracks"?d.shift():a.method==="NowPlaying"&&(d=[d[0]],i=!0);else if(a.method==="NowPlaying")return c.empty(),this;e[++g]=a.contentBefore;e[++g]=i?"<ul>":"<ol>";h.each(d,function(c,b){var f,d,i,j,l,k;a.image&&(b.image&&h.each(b.image,function(b,c){c.size===a.imageSize&&(d=c["#text"],a.imageSquare&&(d=d.replace(/(http:\/\/userserve-ak.last.fm\/serve\/(34|64|126))\//,"$1s/")))}),d||(d="http://cdn.last.fm/flatness/catalogue/noimage/2/default_artist_"+a.imageSize+".png"),i=a.text?"":!b.artist?b.name.escapeHTML():b.artist.name?b.name.escapeHTML()+" &#8211; "+b.artist.name.escapeHTML():b.artist["#text"]?b.name.escapeHTML()+" &#8211; "+b.artist["#text"].escapeHTML():"");a.text?b.artist&&(j=b.artist.name?b.artist.name:b.artist["#text"],l=b.artist.url?b.artist.url:"http://www.last.fm/music/"+j.replace(/\s/g,"+")):f=i;a.playcount&&b.playcount&&(k=b.url.replace(/^(http:\/\/www\.last\.fm\/)/,"$1user/"+a.user+"/library/"));e[++g]="<li>";e[++g]='<a href="'+b.url+'"';e[++g]=f?' title="'+f+'"':"";e[++g]=' class="item">';e[++g]=a.image?'<img src="'+d+'" alt="'+i+'" class="photo">':"";e[++g]=a.text?'<span class="name">'+b.name+"</span>":"";e[++g]="</a>";e[++g]=a.text&&b.artist?' &#8211; <a href="'+l+'" class="artist">'+j+"</a>":"";e[++g]=k?' <span class="playcount">(<a href="'+k+'">'+b.playcount+" plays</a>)</span>":"";e[++g]="</li>"});e[++g]=i?"</ul>":"</ol>";e[++g]=a.contentAfter;c[0].innerHTML=e.join("")})})};h.fn.loadLastfmProfile.defaults={user:"LAST.HQ",method:"TopAlbums",period:"7day",limit:10,image:!0,imageSize:"medium",imageSquare:!0,text:!0,playcount:!0,loadingMessage:"Loading&#8230;",contentBefore:"",contentAfter:""}})(jQuery);String.prototype.escapeHTML=function(){var h=/["&<>]/g,f={'"':"&quot;","&":"&amp;","<":"&lt;",">":"&gt;"};return function(){return this.replace(h,function(c){return f[c]})}}();